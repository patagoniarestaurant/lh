<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Patagonia Restaurant — Menú Digital (Mercado Pago)</title>

<!-- Fuentes + FontAwesome -->
<link href="https://fonts.googleapis.com/css2?family=Sanchez&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- jsPDF para comprobante -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{
    --bg:#000000; --surface:#000000; --surface-light:#1a1a1a; --text:#ffffff;
    --text-muted:#a0a0a0; --accent:#d4af37; --accent-dark:#b8941f; --radius:12px;
    --border:rgba(255,255,255,0.08); --shadow:0 10px 25px rgba(0,0,0,0.5); --transition:all .25s ease;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;font-family:'Sanchez',serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
  .container{max-width:1100px;margin:0 auto;padding:12px}
  header{position:sticky;top:0;background:rgba(0,0,0,.95);border-bottom:1px solid var(--border);padding:12px 0;z-index:100}
  .header-content{display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:12px;align-items:center}
  .hamburger-menu{display:flex;flex-direction:column;gap:4px;cursor:pointer;padding:6px}
  .hamburger-menu span{width:22px;height:2px;background:var(--accent)}
  .restaurant-cover{width:60px;height:50px;border-radius:8px;object-fit:cover;border:2px solid var(--accent)}
  .brand-text h1{font-size:16px;color:var(--text)}
  .nav-buttons{display:flex;gap:10px;margin:12px 0}
  .nav-btn{background:var(--accent);color:var(--text);padding:10px 12px;border-radius:10px;border:1px solid var(--accent);cursor:pointer;transition:var(--transition)}
  .nav-btn:hover{background:var(--accent-dark)}
  .view{display:none}
  .view.active{display:block}
  .cover-image{width:100%;height:150px;object-fit:cover;border-radius:var(--radius);margin-bottom:12px}
  .profile-section{text-align:center;margin-bottom:12px}
  .profile-image{width:100px;height:100px;border-radius:50%;object-fit:cover;border:4px solid var(--accent);margin:0 auto 8px}
  .contact-info,.hours-section,.customer-category,.category-section{background:var(--surface);padding:12px;border-radius:12px;margin-bottom:12px;border:1px solid var(--border)}
  .menu-section{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .dishes-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .dish-card{background:var(--surface-light);border-radius:12px;overflow:hidden;border:1px solid var(--border);display:flex;flex-direction:column;cursor:pointer;aspect-ratio:1;transition:var(--transition)}
  .dish-card.selected{border:2px solid var(--accent);box-shadow:0 0 15px var(--accent)}
  .dish-image{height:65%;position:relative}
  .dish-image img{width:100%;height:100%;object-fit:cover}
  .dish-content{padding:8px;display:flex;flex-direction:column;justify-content:space-between;flex:1}
  .dish-header{display:flex;justify-content:space-between;align-items:flex-start}
  .dish-name{font-weight:700;color:var(--accent)}
  .dish-price{color:var(--accent);font-weight:800}
  .dish-actions{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
  .qty-btn{width:28px;height:28px;border-radius:50%;border:1px solid var(--border);background:transparent;cursor:pointer;color:var(--accent)}
  .add-to-cart-btn{background:var(--accent);color:var(--bg);border:none;padding:6px 10px;border-radius:10px;cursor:pointer}
  .sidebar-nav{position:fixed;left:-320px;top:0;width:320px;height:100vh;background:var(--surface);padding:12px;border-right:1px solid var(--border);transition:var(--transition);z-index:1200;overflow-y:auto}
  .sidebar-nav.open{left:0}
  .sidebar-overlay{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);opacity:0;visibility:hidden;transition:var(--transition);z-index:1100}
  .sidebar-overlay.open{opacity:1;visibility:visible}
  .cart-sidebar{position:fixed;right:-100%;top:0;width:100%;max-width:420px;height:100vh;background:var(--surface);padding:12px;border-left:1px solid var(--border);transition:var(--transition);z-index:1300}
  .cart-sidebar.open{right:0}
  .cart-overlay{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5);opacity:0;visibility:hidden;transition:var(--transition);z-index:1250}
  .cart-overlay.open{opacity:1;visibility:visible}
  .modal,.dish-detail-modal,.payment-choice-modal,.registration-modal,.login-modal{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.7);z-index:1400;opacity:0;visibility:hidden;transition:var(--transition)}
  .modal.open,.dish-detail-modal.open,.payment-choice-modal.open,.registration-modal.open,.login-modal.open{opacity:1;visibility:visible}
  .modal-content,.dish-detail-content{background:var(--surface);padding:16px;border-radius:12px;max-width:520px;width:95%;max-height:90vh;overflow:auto}
  .calculator{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .calculator-display{grid-column:1/-1;background:var(--surface-light);padding:10px;border-radius:8px;border:1px solid var(--border);text-align:right}
  .calculator-btn{padding:12px;border-radius:8px;border:1px solid var(--border);background:transparent;cursor:pointer;color:var(--accent)}
  .toast{position:fixed;right:16px;bottom:16px;padding:10px 14px;border-radius:8px;background:var(--surface);border-left:4px solid var(--accent);transform:translateY(40px);opacity:0;transition:var(--transition);z-index:1600}
  .toast.show{transform:translateY(0);opacity:1}
  .hidden{display:none!important}
  footer{background:var(--surface);padding:20px;margin-top:20px;border-top:1px solid var(--border);text-align:center}
  .customer-categories{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .customer-category{background:var(--surface);padding:12px;border-radius:12px;border:1px solid var(--border)}
  .customer-category h3{color:var(--accent);text-align:center;margin-bottom:8px}
  .customer-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)}
  .customer-item:last-child{border-bottom:none}
  .customer-name{color:var(--text)}
  .customer-score{color:var(--accent);font-weight:700}
  .filter-section{background:var(--surface);padding:12px;border-radius:12px;margin-bottom:12px;border:1px solid var(--border)}
  .filter-options{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .filter-tag{background:var(--surface-light);color:var(--text);padding:6px 12px;border-radius:20px;border:1px solid var(--border);cursor:pointer;transition:var(--transition)}
  .filter-tag.selected{background:var(--accent);color:var(--bg)}
  .split-calculator{margin-top:12px;padding:12px;background:var(--surface-light);border-radius:8px;border:1px solid var(--border)}
  .split-options{display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin-top:8px}
  .split-option{background:var(--surface);color:var(--text);padding:8px;border-radius:8px;border:1px solid var(--border);cursor:pointer;text-align:center;transition:var(--transition)}
  .split-option.selected{background:var(--accent);color:var(--bg)}
  .category-carousel{display:flex;overflow-x:auto;gap:12px;padding:8px 0;scroll-snap-type:x mandatory}
  .category-carousel::-webkit-scrollbar{height:6px}
  .category-carousel::-webkit-scrollbar-track{background:var(--surface-light);border-radius:3px}
  .category-carousel::-webkit-scrollbar-thumb{background:var(--accent);border-radius:3px}
  .category-carousel-item{flex:0 0 auto;width:calc(50% - 6px);scroll-snap-align:start}
  .favorites-section{margin-top:16px;padding-top:16px;border-top:1px solid var(--border)}
  .favorite-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)}
  .favorite-item:last-child{border-bottom:none}
  .favorite-vote{display:flex;gap:4px;align-items:center}
  .vote-btn{background:transparent;border:none;color:var(--accent);cursor:pointer;font-size:16px}
  .vote-count{min-width:20px;text-align:center}
  .price-inputs{display:flex;gap:8px}
  .price-inputs input{flex:1;padding:8px;border-radius:8px;background:var(--surface-light);border:1px solid var(--border);color:var(--text);width:100%}
  @media(max-width:800px){
    .menu-section,.dishes-grid{grid-template-columns:repeat(1,1fr)} 
    .dish-card{aspect-ratio:1.5} 
    .restaurant-cover{display:none}
    .customer-categories{grid-template-columns:1fr}
    .split-options{grid-template-columns:repeat(3,1fr)}
    .category-carousel-item{width:calc(100% - 6px)}
  }
  @media(max-width:480px){
    .dishes-grid{grid-template-columns:repeat(2,1fr)}
    .dish-card{aspect-ratio:1}
    .category-carousel-item{width:calc(100% - 6px)}
  }
</style>
</head>
<body>

<!-- TOAST -->
<div id="toast" class="toast"></div>

<!-- SIDEBAR -->
<div id="sidebarOverlay" class="sidebar-overlay"></div>
<aside id="sidebarNav" class="sidebar-nav" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
    <h3 style="color:var(--accent)">Menú</h3>
    <button id="closeSidebar" class="nav-btn"><i class="fas fa-times"></i></button>
  </div>

  <div style="margin-bottom:10px;display:flex;flex-direction:column;gap:8px">
    <button id="sidebarLoginBtn" class="nav-btn"><i class="fas fa-sign-in-alt"></i> Iniciar Sesión</button>
    <button id="sidebarRegisterBtn" class="nav-btn"><i class="fas fa-user-plus"></i> Registrarse</button>
  </div>

  <div style="margin-bottom:10px">
    <div style="position:relative">
      <i class="fas fa-search" style="position:absolute;left:10px;top:10px;color:var(--text-muted)"></i>
      <input id="sidebarSearch" style="width:100%;padding:10px 12px 10px 36px;border-radius:8px;background:var(--surface-light);border:1px solid var(--border);color:var(--text)" placeholder="Buscar platos...">
    </div>
  </div>

  <div class="filter-section">
    <h4 style="color:var(--accent);margin-bottom:8px">Filtrar por precio</h4>
    <div class="price-inputs">
      <input id="minPrice" type="number" placeholder="Mín" style="width:100%">
      <input id="maxPrice" type="number" placeholder="Máx" style="width:100%">
    </div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="applyPriceFilter" class="nav-btn" style="flex:1">Aplicar</button>
      <button id="clearPriceFilter" class="nav-btn" style="flex:1">Limpiar</button>
    </div>
  </div>

  <div class="filter-section">
    <h4 style="color:var(--accent);margin-bottom:8px">Etiquetas de alimentos</h4>
    <div class="filter-options" id="foodTags">
      <div class="filter-tag" data-tag="vegetariano">Vegetariano</div>
      <div class="filter-tag" data-tag="vegano">Vegano</div>
      <div class="filter-tag" data-tag="sin-gluten">Sin Gluten</div>
      <div class="filter-tag" data-tag="picante">Picante</div>
      <div class="filter-tag" data-tag="bajo-calorias">Bajo Calorías</div>
    </div>
  </div>

  <div id="categoriesSidebar" style="display:flex;flex-direction:column;gap:8px"></div>

  <div class="favorites-section">
    <h4 style="color:var(--accent);margin-bottom:8px">Platos Favoritos</h4>
    <div id="favoritesList"></div>
  </div>
</aside>

<!-- CART -->
<div id="cartOverlay" class="cart-overlay"></div>
<aside id="cartSidebar" class="cart-sidebar" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <h3 style="color:var(--accent)">Tu Pedido</h3>
    <button id="closeCart" class="nav-btn"><i class="fas fa-times"></i></button>
  </div>
  <div id="cartItems" style="max-height:55vh;overflow:auto"></div>
  <div style="border-top:1px solid var(--border);padding-top:12px;margin-top:12px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <strong>Total:</strong><strong id="cartTotal">$0</strong>
    </div>
    <button id="checkoutBtn" class="nav-btn" style="width:100%;background:var(--accent);color:var(--bg)">Proceder al Pago</button>
    <div id="pendingPayment" class="hidden" style="margin-top:12px">
      <div style="padding:10px;border:1px solid var(--accent);border-radius:8px">Pago Pendiente</div>
      <button id="requestBillBtn" class="nav-btn" style="width:100%;margin-top:8px"><i class="fas fa-receipt"></i> Pedir la Cuenta</button>
    </div>
  </div>
</aside>

<header>
  <div class="container">
    <div class="header-content">
      <div class="brand">
        <div id="hamburgerMenu" class="hamburger-menu" title="Abrir menú">
          <span></span><span></span><span></span>
        </div>
        <img id="headerRestaurantImage" class="restaurant-cover" src="" alt="Patagonia">
        <div class="brand-text">
          <h1 id="headerTitle">Patagonia Restaurant</h1>
          <div id="headerSlogan" style="font-size:12px;color:var(--text-muted)">Sabores sin fronteras, experiencia sin límites</div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:12px">
        <button id="cartIcon" class="nav-btn" title="Abrir carrito"><i class="fas fa-shopping-cart"></i><span id="cartCount" style="background:var(--accent);color:var(--text);border-radius:50%;padding:2px 6px;margin-left:6px">0</span></button>
      </div>
    </div>
  </div>
</header>

<main class="container">
  <div class="nav-buttons">
    <button id="backBtn" class="nav-btn"><i class="fas fa-arrow-left"></i> Retroceder</button>
    <button id="homeBtn" class="nav-btn"><i class="fas fa-home"></i> Menú Principal</button>
    <button id="menuBtn" class="nav-btn"><i class="fas fa-utensils"></i> Ver Menú Digital</button>
  </div>

  <!-- HOME VIEW -->
  <section id="homeView" class="view active">
    <img id="coverImage" class="cover-image" src="" alt="Cover">
    <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
      <div style="display:flex;gap:8px;align-items:center">
        <div style="width:10px;height:10px;border-radius:50%;background:var(--accent)"></div>
        <div id="statusText" style="color:var(--text-muted)">Abierto</div>
      </div>
      <button id="callWaiterBtn" class="nav-btn" style="margin-left:auto"><i class="fas fa-bell"></i> Llamar al Mozo</button>
    </div>

    <div class="profile-section">
      <img id="profileImage" class="profile-image" src="" alt="Profile">
      <h2 id="profileName" style="color:var(--text)">Patagonia Restaurant</h2>
      <p id="profileSlogan" style="color:var(--text-muted)">Sabores sin fronteras, experiencia sin límites</p>
    </div>

    <section class="contact-info">
      <h3 style="color:var(--text)">Contacto</h3>
      <div style="display:grid;gap:8px;margin-top:8px">
        <div style="display:flex;gap:8px;align-items:center">
          <i class="fab fa-whatsapp" style="background:var(--accent);padding:8px;border-radius:8px"></i>
          <div><div style="font-size:12px;color:var(--text-muted)">WhatsApp</div><a class="contact-link" href="https://wa.me/542974705984" target="_blank" style="color:var(--text)">+54 297 470-5984</a></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <i class="fab fa-instagram" style="background:var(--accent);padding:8px;border-radius:8px"></i>
          <div><div style="font-size:12px;color:var(--text-muted)">Instagram</div><a class="contact-link" href="https://instagram.com/patagoniarestaurant" target="_blank" style="color:var(--text)">@patagoniarestaurant</a></div>
        </div>
      </div>
    </section>

    <section id="hoursSection" class="hours-section">
      <h3 style="color:var(--text)">Horarios de Atención</h3>
      <div id="hoursList" style="margin-top:8px"></div>
    </section>

    <section id="customerCategories" class="customer-categories"></section>
  </section>

  <!-- MENU VIEW -->
  <section id="menuView" class="view">
    <section id="menuSection" class="menu-section"></section>
  </section>
</main>

<footer>
  <div class="container">
    <div style="color:var(--text-muted);font-size:13px">Patagonia Restaurant — Las Heras, Santa Cruz • Domingo F. Sarmiento 494 • Tel: 2974705984</div>
    <div style="margin-top:8px;color:var(--text-muted)">© 2025 Patagonia Restaurant. Todos los derechos reservados.</div>
  </div>
</footer>

<!-- Dish detail modal -->
<div id="dishDetailModal" class="dish-detail-modal" aria-hidden="true">
  <div class="dish-detail-content">
    <div style="position:relative">
      <img id="detailImage" src="" alt="Detalle" style="width:100%;height:220px;object-fit:cover;border-radius:8px">
      <button id="closeDetail" class="nav-btn" style="position:absolute;top:10px;right:10px"><i class="fas fa-times"></i></button>
    </div>
    <div style="padding-top:12px">
      <h3 id="detailName" style="color:var(--accent)"></h3>
      <div id="detailPrice" style="font-weight:700;color:var(--accent);margin-bottom:8px"></div>
      <p id="detailDescription" style="color:var(--text-muted)"></p>
      <div id="detailTags" style="display:flex;gap:4px;margin:8px 0;flex-wrap:wrap"></div>

      <div style="display:flex;gap:12px;align-items:center;margin-top:12px">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="detailDecrease" class="qty-btn"><i class="fas fa-minus"></i></button>
          <span id="detailQuantity" style="min-width:26px;text-align:center;font-weight:700">1</span>
          <button id="detailIncrease" class="qty-btn"><i class="fas fa-plus"></i></button>
        </div>
        <button id="detailAddToCart" class="add-to-cart-btn"><i class="fas fa-shopping-cart"></i> Agregar</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="detailReset" class="nav-btn" style="flex:1">Restablecer</button>
        <button id="detailFavorite" class="nav-btn" style="flex:1"><i class="far fa-heart"></i> Favorito</button>
      </div>
    </div>
  </div>
</div>

<!-- Payment choice modal -->
<div id="paymentChoiceModal" class="payment-choice-modal">
  <div class="modal-content">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="color:var(--accent)">Opciones de Pago</h3>
      <button id="closePaymentChoice" class="nav-btn"><i class="fas fa-times"></i></button>
    </div>

    <div style="display:grid;gap:10px;margin-top:12px">
      <div class="nav-btn payment-choice-option" data-choice="now"><i class="fas fa-credit-card"></i> Pagar Ahora</div>
      <div class="nav-btn payment-choice-option" data-choice="later"><i class="fas fa-clock"></i> Pagar al Finalizar</div>
    </div>

    <!-- Calculator -->
    <div class="split-calculator">
      <h4 style="color:var(--accent);margin-bottom:8px">Dividir la cuenta</h4>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>Total:</div>
        <div id="splitTotal" style="font-weight:700;color:var(--accent)">$0</div>
      </div>
      <div>Dividir entre:</div>
      <div class="split-options">
        <div class="split-option" data-split="1">1</div>
        <div class="split-option" data-split="2">2</div>
        <div class="split-option" data-split="3">3</div>
        <div class="split-option" data-split="4">4</div>
        <div class="split-option" data-split="5">5</div>
        <div class="split-option" data-split="6">6</div>
        <div class="split-option" data-split="7">7</div>
        <div class="split-option" data-split="8">8</div>
        <div class="split-option" data-split="9">9</div>
        <div class="split-option" data-split="10">10</div>
        <div class="split-option" data-split="11">11</div>
        <div class="split-option" data-split="12">12</div>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <div>Total por persona:</div>
        <div id="splitPerPerson" style="font-weight:700;color:var(--accent)">$0</div>
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="confirmPaymentChoice" class="nav-btn" style="flex:1;background:var(--accent);color:var(--bg)"><i class="fas fa-check"></i> Confirmar</button>
      <button id="cancelPaymentChoice" class="nav-btn" style="flex:1">Cancelar</button>
    </div>
  </div>
</div>

<!-- Payment modal -->
<div id="paymentModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="color:var(--accent)">Método de Pago</h3>
      <button id="closePayment" class="nav-btn"><i class="fas fa-times"></i></button>
    </div>

    <div style="display:grid;gap:8px;margin-top:12px">
      <div class="nav-btn payment-option" data-method="mercado-pago"><i class="fas fa-credit-card"></i> Mercado Pago (real / sandbox)</div>
      <div class="nav-btn payment-option" data-method="transferencia"><i class="fas fa-university"></i> Transferencia Bancaria</div>
      <div class="nav-btn payment-option" data-method="debito"><i class="fas fa-credit-card"></i> Tarjeta Débito (local)</div>
    </div>

    <div style="margin-top:12px">
      <label style="color:var(--text-muted)">Propina</label>
      <div style="display:flex;gap:8px;margin-top:8px">
        <div class="nav-btn tip-option" data-tip="0">No dejar</div>
        <div class="nav-btn tip-option" data-tip="5">5%</div>
        <div class="nav-btn tip-option" data-tip="10">10%</div>
        <div class="nav-btn tip-option" data-tip="15">15%</div>
      </div>
    </div>

    <div id="paymentReceipt" class="receipt" style="margin-top:12px;background:var(--surface-light);padding:10px;border-radius:8px"></div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="confirmPayment" class="nav-btn" style="flex:1;background:var(--accent);color:var(--bg)"><i class="fas fa-check"></i> Confirmar Pago</button>
      <button id="cancelPayment" class="nav-btn" style="flex:1">Cancelar</button>
    </div>
  </div>
</div>

<!-- Registration modal -->
<div id="registrationModal" class="registration-modal" aria-hidden="true">
  <div class="registration-content">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="color:var(--accent)">Registro</h3>
      <button id="closeRegistration" class="nav-btn"><i class="fas fa-times"></i></button>
    </div>

    <div style="margin-top:12px">
      <label class="form-label">Número de celular</label>
      <input id="phoneNumber" class="form-input" placeholder="+54 9 11 1234-5678" style="width:100%;padding:10px;border-radius:8px;background:var(--surface-light);border:1px solid var(--border);color:var(--text)">
    </div>
    <div style="margin-top:8px">
      <label class="form-label">Contraseña</label>
      <input id="password" type="password" class="form-input" placeholder="Contraseña" style="width:100%;padding:10px;border-radius:8px;background:var(--surface-light);border:1px solid var(--border);color:var(--text)">
    </div>
    <div style="margin-top:8px">
      <label class="form-label">Alias (opcional)</label>
      <input id="alias" class="form-input" placeholder="Alias" style="width:100%;padding:10px;border-radius:8px;background:var(--surface-light);border:1px solid var(--border);color:var(--text)">
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="sendVerificationCode" class="nav-btn" style="flex:1;background:var(--accent);color:var(--bg)">Enviar Código</button>
      <button id="cancelRegistration" class="nav-btn" style="flex:1">Cancelar</button>
    </div>

    <div id="verificationSection" class="hidden" style="margin-top:12px">
      <label class="form-label">Código de verificación</label>
      <input id="verificationCode" class="form-input" placeholder="123456" maxlength="6" style="width:100%;padding:10px;border-radius:8px;background:var(--surface-light);border:1px solid var(--border);color:var(--text)">
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="verifyCode" class="nav-btn" style="flex:1;background:var(--accent);color:var(--bg)">Verificar</button>
      </div>
    </div>
  </div>
</div>

<!-- Login modal -->
<div id="loginModal" class="login-modal" aria-hidden="true">
  <div class="login-content">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="color:var(--accent)">Iniciar Sesión</h3>
      <button id="closeLogin" class="nav-btn"><i class="fas fa-times"></i></button>
    </div>

    <div style="margin-top:12px">
      <label>Número de celular</label>
      <input id="loginPhone" class="form-input" placeholder="+54 9 11 1234-5678" style="width:100%;padding:10px;border-radius:8px;background:var(--surface-light);border:1px solid var(--border);color:var(--text)">
    </div>
    <div style="margin-top:8px">
      <label>Contraseña</label>
      <input id="loginPassword" type="password" class="form-input" placeholder="Contraseña" style="width:100%;padding:10px;border-radius:8px;background:var(--surface-light);border:1px solid var(--border);color:var(--text)">
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="loginBtn" class="nav-btn" style="flex:1;background:var(--accent);color:var(--bg)"><i class="fas fa-sign-in-alt"></i> Iniciar</button>
      <button id="cancelLogin" class="nav-btn" style="flex:1">Cancelar</button>
    </div>
  </div>
</div>

<script>
/* ============================
   CONFIG: Cambiar al desplegar
   ============================ */
// Por defecto usa localhost (útil para pruebas locales).
// Cuando despliegues el backend (ej. en Render), reemplaza por:
// const BACKEND_URL = "https://tu-backend.onrender.com";
const BACKEND_URL = "http://localhost:3000";

/* ============================
   Datos del menú (simulados)
   ============================ */
const MENU_DATA = {
  restaurant: 'Patagonia Restaurant',
  slogan: 'Sabores sin fronteras, experiencia sin límites',
  coverImage: 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?auto=format&fit=crop&w=2000&q=80',
  profileImage: 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?auto=format&fit=crop&w=500&q=80',
  hours: [
    {day:'Lunes', time:'Cerrado'},
    {day:'Martes', time:'18:00 - 23:00'},
    {day:'Miércoles', time:'18:00 - 23:00'},
    {day:'Jueves', time:'18:00 - 23:00'},
    {day:'Viernes', time:'18:00 - 01:00'},
    {day:'Sábado', time:'12:00 - 01:00'},
    {day:'Domingo', time:'12:00 - 18:00'}
  ],
  categories: [
    { id:'especialidad-chef', name:'Especialidad del Chef', subcategories: [
      { id:'platos-casa', name:'Platos de la Casa' },
      { id:'postres-casa', name:'Postres de la Casa' }
    ]},
    { id:'principales', name:'Platos Principales' },
    { id:'bebidas-sin-alcohol', name:'Bebidas sin Alcohol' },
    { id:'acompanamientos', name:'Acompañamientos' },
    { id:'aperitivos', name:'Aperitivos' },
    { id:'postres', name:'Postres' },
    { id:'te-infusiones', name:'Té e Infusiones' },
    { id:'cafe', name:'Café' },
    { id:'jugos', name:'Jugos' },
    { id:'vinos', name:'Vinos' },
    { id:'tragos', name:'Tragos' }
  ],
  dishes: [
    // Especialidad del Chef - Platos de la Casa
    { id:'d1', name:'Provoleta a la parrilla', price:1200, category:'platos-casa', description:'Provoleta con orégano y chimichurri', img:'https://images.unsplash.com/photo-1628071237366-ea5d0f1b2e94?auto=format&fit=crop&w=800&q=60', tags:['vegetariano', 'sin-gluten'] },
    { id:'d2', name:'Empanadas de carne', price:350, category:'platos-casa', description:'Empanadas tradicionales', img:'https://images.unsplash.com/photo-1544025162-d76694265947?auto=format&fit=crop&w=800&q=60', tags:[] },
    
    // Especialidad del Chef - Postres de la Casa
    { id:'d3', name:'Postre de la casa', price:900, category:'postres-casa', description:'Chocolate, frutos rojos y crema', img:'https://images.unsplash.com/photo-1551782450-a2132b4ba21d?auto=format&fit=crop&w=800&q=60', tags:['vegetariano'] },
    { id:'d4', name:'Flan casero', price:750, category:'postres-casa', description:'Flan con dulce de leche', img:'https://images.unsplash.com/photo-1578985545062-69928b1d9587?auto=format&fit=crop&w=800&q=60', tags:['vegetariano'] },
    
    // Platos Principales
    { id:'d5', name:'Asado Patagonia (porción)', price:4200, category:'principales', description:'Corte seleccionado, acompañado de papas calientes', img:'https://images.unsplash.com/photo-1604908177522-89f13d0b0fda?auto=format&fit=crop&w=800&q=60', tags:[] },
    { id:'d6', name:'Salmón al horno', price:3800, category:'principales', description:'Salmón fresco con emulsión cítrica', img:'https://images.unsplash.com/photo-1544025162-3e5a6cb4b1f6?auto=format&fit=crop&w=800&q=60', tags:['bajo-calorias'] },
    
    // Bebidas sin Alcohol
    { id:'d7', name:'Agua mineral', price:300, category:'bebidas-sin-alcohol', description:'Agua mineral 500ml', img:'https://images.unsplash.com/photo-1548839148-108717728f7f?auto=format&fit=crop&w=800&q=60', tags:['vegano', 'sin-gluten'] },
    { id:'d8', name:'Gaseosa', price:400, category:'bebidas-sin-alcohol', description:'Gaseosa 500ml', img:'https://images.unsplash.com/photo-1621506289937-a8e4df240d0b?auto=format&fit=crop&w=800&q=60', tags:['vegano', 'sin-gluten'] },
    
    // Acompañamientos
    { id:'d9', name:'Papas fritas', price:600, category:'acompanamientos', description:'Papas fritas crujientes', img:'https://images.unsplash.com/photo-1573080496219-bb080dd4f877?auto=format&fit=crop&w=800&q=60', tags:['vegetariano', 'vegano'] },
    { id:'d10', name:'Ensalada mixta', price:500, category:'acompanamientos', description:'Lechuga, tomate y cebolla', img:'https://images.unsplash.com/photo-1540420773420-3366772f4999?auto=format&fit=crop&w=800&q=60', tags:['vegetariano', 'vegano', 'bajo-calorias'] },
    
    // Aperitivos
    { id:'d11', name:'Aceitunas', price:350, category:'aperitivos', description:'Aceitunas verdes y negras', img:'https://images.unsplash.com/photo-1608039755407-31c2f7f1d3ca?auto=format&fit=crop&w=800&q=60', tags:['vegetariano', 'vegano'] },
    { id:'d12', name:'Pan con ajo', price:450, category:'aperitivos', description:'Pan tostado con ajo y perejil', img:'https://images.unsplash.com/photo-1573140247632-f8fd74997d5c?auto=format&fit=crop&w=800&q=60', tags:['vegetariano'] },
    
    // Postres
    { id:'d13', name:'Tiramisú', price:950, category:'postres', description:'Postre italiano con café y cacao', img:'https://images.unsplash.com/photo-1571877227200-a0d98ea607e9?auto=format&fit=crop&w=800&q=60', tags:['vegetariano'] },
    { id:'d14', name:'Cheesecake', price:850, category:'postres', description:'Tarta de queso con frutos rojos', img:'https://images.unsplash.com/photo-1524351199678-941a58a3df50?auto=format&fit=crop&w=800&q=60', tags:['vegetariano'] },
    
    // Té e Infusiones
    { id:'d15', name:'Té negro', price:250, category:'te-infusiones', description:'Té negro de calidad premium', img:'https://images.unsplash.com/photo-1556679343-c7306c1976bc?auto=format&fit=crop&w=800&q=60', tags:['vegano', 'sin-gluten'] },
    { id:'d16', name:'Manzanilla', price:250, category:'te-infusiones', description:'Infusión de manzanilla relajante', img:'https://images.unsplash.com/photo-1597481499750-3e11b3e6c6c9?auto=format&fit=crop&w=800&q=60', tags:['vegano', 'sin-gluten'] },
    
    // Café
    { id:'d17', name:'Café espresso', price:300, category:'cafe', description:'Café espresso intenso', img:'https://images.unsplash.com/photo-1514432324607-a09d9b4aefdd?auto=format&fit=crop&w=800&q=60', tags:['vegano', 'sin-gluten'] },
    { id:'d18', name:'Cappuccino', price:450, category:'cafe', description:'Café con leche espumosa', img:'https://images.unsplash.com/photo-1572442388796-11668a67e53d?auto=format&fit=crop&w=800&q=60', tags:['vegetariano'] },
    
    // Jugos
    { id:'d19', name:'Jugo de naranja', price:400, category:'jugos', description:'Jugo de naranja natural', img:'https://images.unsplash.com/photo-1613478223719-2ab802602423?auto=format&fit=crop&w=800&q=60', tags:['vegano', 'sin-gluten'] },
    { id:'d20', name:'Jugo de manzana', price:400, category:'jugos', description:'Jugo de manzana natural', img:'https://images.unsplash.com/photo-1621506289937-a8e4df240d0b?auto=format&fit=crop&w=800&q=60', tags:['vegano', 'sin-gluten'] },
    
    // Vinos
    { id:'d21', name:'Malbec', price:1200, category:'vinos', description:'Vino tinto Malbec argentino', img:'https://images.unsplash.com/photo-1506377247377-2a5b3b417ebb?auto=format&fit=crop&w=800&q=60', tags:['vegano', 'sin-gluten'] },
    { id:'d22', name:'Chardonnay', price:1300, category:'vinos', description:'Vino blanco Chardonnay', img:'https://images.unsplash.com/photo-1510812431401-41d2bd2722f3?auto=format&fit=crop&w=800&q=60', tags:['vegano', 'sin-gluten'] },
    
    // Tragos
    { id:'d23', name:'Fernet con cola', price:800, category:'tragos', description:'Fernet Branca con Coca-Cola', img:'https://images.unsplash.com/photo-1544145945-f90425340c7e?auto=format&fit=crop&w=800&q=60', tags:[] },
    { id:'d24', name:'Gin Tonic', price:900, category:'tragos', description:'Gin con agua tónica y lima', img:'https://images.unsplash.com/photo-1605270012917-bf157c5a9541?auto=format&fit=crop&w=800&q=60', tags:[] }
  ]
};

/* ======== Estado y utilidades ======== */
let state = {
  cart: JSON.parse(localStorage.getItem('cart_v1')) || {},
  favorites: JSON.parse(localStorage.getItem('fav_v1')) || {},
  user: JSON.parse(localStorage.getItem('user_v1')) || null,
  paymentChoice: null,
  paymentMethod: null,
  tipPercent: 0,
  selectedTags: [],
  dishVotes: JSON.parse(localStorage.getItem('dish_votes_v1')) || {},
  lastReceiptLines: [], // para generar PDF después del pago
  lastReceiptTotals: { subtotal:0, tip:0, total:0 }
};

function saveState(){
  localStorage.setItem('cart_v1', JSON.stringify(state.cart));
  localStorage.setItem('fav_v1', JSON.stringify(state.favorites));
  localStorage.setItem('user_v1', JSON.stringify(state.user));
  localStorage.setItem('dish_votes_v1', JSON.stringify(state.dishVotes));
}

function toast(message, type='success'){
  const t = document.getElementById('toast');
  t.textContent = message;
  t.classList.add('show');
  if(type==='error'){ t.style.borderLeft='4px solid #ef4444'; } else { t.style.borderLeft='4px solid var(--accent)'; }
  setTimeout(()=>{ t.classList.remove('show'); t.style.borderLeft='4px solid var(--accent)'; }, 3000);
}

/* ======== Detección de idioma ======== */
function detectLanguage() {
  const userLang = navigator.language || navigator.userLanguage;
  return userLang.split('-')[0]; // Devuelve solo el código principal (es, en, etc.)
}

function translateContent(lang) {
  // Traducciones básicas - en una implementación real, esto sería más completo
  const translations = {
    'es': {
      'menu': 'Menú',
      'search': 'Buscar platos...',
      'priceFilter': 'Filtrar por precio',
      'min': 'Mín',
      'max': 'Máx',
      'apply': 'Aplicar',
      'clear': 'Limpiar',
      'foodTags': 'Etiquetas de alimentos',
      'login': 'Iniciar Sesión',
      'register': 'Registrarse',
      'favorites': 'Platos Favoritos',
      'yourOrder': 'Tu Pedido',
      'total': 'Total',
      'checkout': 'Proceder al Pago',
      'pendingPayment': 'Pago Pendiente',
      'requestBill': 'Pedir la Cuenta',
      'back': 'Retroceder',
      'home': 'Menú Principal',
      'viewMenu': 'Ver Menú Digital',
      'callWaiter': 'Llamar al Mozo',
      'contact': 'Contacto',
      'hours': 'Horarios de Atención',
      'addToCart': 'Agregar',
      'reset': 'Restablecer',
      'favorite': 'Favorito',
      'paymentOptions': 'Opciones de Pago',
      'payNow': 'Pagar Ahora',
      'payLater': 'Pagar al Finalizar',
      'splitBill': 'Dividir la cuenta',
      'splitBetween': 'Dividir entre',
      'perPerson': 'Total por persona',
      'confirm': 'Confirmar',
      'cancel': 'Cancelar',
      'paymentMethod': 'Método de Pago',
      'tip': 'Propina',
      'noTip': 'No dejar',
      'confirmPayment': 'Confirmar Pago'
    },
    'en': {
      'menu': 'Menu',
      'search': 'Search dishes...',
      'priceFilter': 'Filter by price',
      'min': 'Min',
      'max': 'Max',
      'apply': 'Apply',
      'clear': 'Clear',
      'foodTags': 'Food tags',
      'login': 'Login',
      'register': 'Register',
      'favorites': 'Favorite Dishes',
      'yourOrder': 'Your Order',
      'total': 'Total',
      'checkout': 'Proceed to Payment',
      'pendingPayment': 'Pending Payment',
      'requestBill': 'Request Bill',
      'back': 'Back',
      'home': 'Main Menu',
      'viewMenu': 'View Digital Menu',
      'callWaiter': 'Call Waiter',
      'contact': 'Contact',
      'hours': 'Opening Hours',
      'addToCart': 'Add',
      'reset': 'Reset',
      'favorite': 'Favorite',
      'paymentOptions': 'Payment Options',
      'payNow': 'Pay Now',
      'payLater': 'Pay Later',
      'splitBill': 'Split the bill',
      'splitBetween': 'Split between',
      'perPerson': 'Total per person',
      'confirm': 'Confirm',
      'cancel': 'Cancel',
      'paymentMethod': 'Payment Method',
      'tip': 'Tip',
      'noTip': 'No tip',
      'confirmPayment': 'Confirm Payment'
    }
  };

  const t = translations[lang] || translations['es'];
  
  // Aplicar traducciones a elementos específicos
  if (document.getElementById('sidebarSearch')) document.getElementById('sidebarSearch').placeholder = t.search;
  if (document.querySelector('#sidebarNav h3')) document.querySelector('#sidebarNav h3').textContent = t.menu;
  if (document.getElementById('sidebarLoginBtn')) document.getElementById('sidebarLoginBtn').innerHTML = `<i class="fas fa-sign-in-alt"></i> ${t.login}`;
  if (document.getElementById('sidebarRegisterBtn')) document.getElementById('sidebarRegisterBtn').innerHTML = `<i class="fas fa-user-plus"></i> ${t.register}`;
  if (document.querySelector('.filter-section h4')) document.querySelector('.filter-section h4').textContent = t.priceFilter;
  if (document.getElementById('minPrice')) document.getElementById('minPrice').placeholder = t.min;
  if (document.getElementById('maxPrice')) document.getElementById('maxPrice').placeholder = t.max;
  if (document.getElementById('applyPriceFilter')) document.getElementById('applyPriceFilter').textContent = t.apply;
  if (document.getElementById('clearPriceFilter')) document.getElementById('clearPriceFilter').textContent = t.clear;
  if (document.querySelectorAll('.filter-section h4')[1]) document.querySelectorAll('.filter-section h4')[1].textContent = t.foodTags;
  if (document.querySelector('.favorites-section h4')) document.querySelector('.favorites-section h4').textContent = t.favorites;
  if (document.querySelector('#cartSidebar h3')) document.querySelector('#cartSidebar h3').textContent = t.yourOrder;
  if (document.querySelector('#cartSidebar strong:first-child')) document.querySelector('#cartSidebar strong:first-child').textContent = t.total + ':';
  if (document.getElementById('checkoutBtn')) document.getElementById('checkoutBtn').textContent = t.checkout;
  if (document.getElementById('pendingPayment div')) document.getElementById('pendingPayment div').textContent = t.pendingPayment;
  if (document.getElementById('requestBillBtn')) document.getElementById('requestBillBtn').innerHTML = `<i class="fas fa-receipt"></i> ${t.requestBill}`;
  if (document.getElementById('backBtn')) document.getElementById('backBtn').innerHTML = `<i class="fas fa-arrow-left"></i> ${t.back}`;
  if (document.getElementById('homeBtn')) document.getElementById('homeBtn').innerHTML = `<i class="fas fa-home"></i> ${t.home}`;
  if (document.getElementById('menuBtn')) document.getElementById('menuBtn').innerHTML = `<i class="fas fa-utensils"></i> ${t.viewMenu}`;
  if (document.getElementById('callWaiterBtn')) document.getElementById('callWaiterBtn').innerHTML = `<i class="fas fa-bell"></i> ${t.callWaiter}`;
  if (document.querySelector('.contact-info h3')) document.querySelector('.contact-info h3').textContent = t.contact;
  if (document.querySelector('.hours-section h3')) document.querySelector('.hours-section h3').textContent = t.hours;
  if (document.getElementById('detailAddToCart')) document.getElementById('detailAddToCart').innerHTML = `<i class="fas fa-shopping-cart"></i> ${t.addToCart}`;
  if (document.getElementById('detailReset')) document.getElementById('detailReset').textContent = t.reset;
  if (document.getElementById('detailFavorite')) document.getElementById('detailFavorite').innerHTML = `<i class="far fa-heart"></i> ${t.favorite}`;
  if (document.querySelector('#paymentChoiceModal h3')) document.querySelector('#paymentChoiceModal h3').textContent = t.paymentOptions;
  if (document.querySelector('.payment-choice-option[data-choice="now"]')) document.querySelector('.payment-choice-option[data-choice="now"]').innerHTML = `<i class="fas fa-credit-card"></i> ${t.payNow}`;
  if (document.querySelector('.payment-choice-option[data-choice="later"]')) document.querySelector('.payment-choice-option[data-choice="later"]').innerHTML = `<i class="fas fa-clock"></i> ${t.payLater}`;
  if (document.querySelector('.split-calculator h4')) document.querySelector('.split-calculator h4').textContent = t.splitBill;
  if (document.querySelector('.split-calculator div:nth-child(3)')) document.querySelector('.split-calculator div:nth-child(3)').textContent = t.splitBetween;
  if (document.querySelector('.split-calculator div:last-child')) document.querySelector('.split-calculator div:last-child').textContent = t.perPerson;
  if (document.getElementById('confirmPaymentChoice')) document.getElementById('confirmPaymentChoice').innerHTML = `<i class="fas fa-check"></i> ${t.confirm}`;
  if (document.getElementById('cancelPaymentChoice')) document.getElementById('cancelPaymentChoice').textContent = t.cancel;
  if (document.querySelector('#paymentModal h3')) document.querySelector('#paymentModal h3').textContent = t.paymentMethod;
  if (document.querySelector('#paymentModal label')) document.querySelector('#paymentModal label').textContent = t.tip;
  if (document.querySelector('.tip-option[data-tip="0"]')) document.querySelector('.tip-option[data-tip="0"]').textContent = t.noTip;
  if (document.getElementById('confirmPayment')) document.getElementById('confirmPayment').innerHTML = `<i class="fas fa-check"></i> ${t.confirmPayment}`;
  if (document.getElementById('cancelPayment')) document.getElementById('cancelPayment').textContent = t.cancel;
}

/* ======== Inicialización UI ======== */
function initUI(){
  // Detectar idioma y traducir
  const userLang = detectLanguage();
  if (userLang !== 'es') {
    translateContent(userLang);
  }

  // Header content
  document.getElementById('coverImage').src = MENU_DATA.coverImage;
  document.getElementById('profileImage').src = MENU_DATA.profileImage;
  document.getElementById('headerRestaurantImage').src = MENU_DATA.coverImage;
  document.getElementById('profileName').textContent = MENU_DATA.restaurant;
  document.getElementById('profileSlogan').textContent = MENU_DATA.slogan;

  // Hours
  const hoursList = document.getElementById('hoursList');
  hoursList.innerHTML = '';
  MENU_DATA.hours.forEach(h => {
    const div = document.createElement('div');
    div.style.display='flex'; div.style.justifyContent='space-between'; div.style.padding='6px 0';
    div.innerHTML = `<div>${h.day}</div><div style="color:var(--text-muted)">${h.time}</div>`;
    hoursList.appendChild(div);
  });

  // Categories in sidebar
  const categoriesSidebar = document.getElementById('categoriesSidebar');
  categoriesSidebar.innerHTML = '';
  MENU_DATA.categories.forEach(c => {
    if (c.subcategories) {
      // Categoría con subcategorías
      c.subcategories.forEach(sub => {
        const btn = document.createElement('button');
        btn.className='nav-btn';
        btn.textContent = sub.name;
        btn.dataset.cat = sub.id;
        btn.addEventListener('click', () => {
          showCategory(sub.id);
          closeSidebar();
        });
        categoriesSidebar.appendChild(btn);
      });
    } else {
      // Categoría simple
      const btn = document.createElement('button');
      btn.className='nav-btn';
      btn.textContent = c.name;
      btn.dataset.cat = c.id;
      btn.addEventListener('click', () => {
        showCategory(c.id);
        closeSidebar();
      });
      categoriesSidebar.appendChild(btn);
    }
  });

  // Customer categories (home) - Top de clientes
  const customerCategories = document.getElementById('customerCategories');
  customerCategories.innerHTML = '';
  
  // Generar nombres aleatorios para clientes
  const firstNames = ['Juan', 'María', 'Carlos', 'Ana', 'Luis', 'Laura', 'Pedro', 'Sofía', 'Diego', 'Elena'];
  const lastNames = ['Gómez', 'Rodríguez', 'Fernández', 'López', 'Martínez', 'Pérez', 'García', 'Sánchez', 'Romero', 'Torres'];
  
  // Crear 3 categorías de clientes
  const customerCategoriesData = [
    { name: 'Clientes Frecuentes', color: '#d4af37' },
    { name: 'Clientes VIP', color: '#c0c0c0' },
    { name: 'Nuevos Clientes', color: '#cd7f32' }
  ];
  
  customerCategoriesData.forEach(category => {
    const section = document.createElement('div');
    section.className='customer-category';
    section.innerHTML = `<h3 style="color:${category.color}">${category.name}</h3><div class="customer-list" id="list_${category.name.replace(/\s+/g, '')}"></div>`;
    customerCategories.appendChild(section);
    
    const list = section.querySelector(`#list_${category.name.replace(/\s+/g, '')}`);
    
    // Generar 3 clientes aleatorios con puntajes entre 50-350
    for (let i = 0; i < 3; i++) {
      const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
      const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
      const score = Math.floor(Math.random() * 301) + 50; // Puntaje entre 50-350
      
      const item = document.createElement('div');
      item.className = 'customer-item';
      item.innerHTML = `
        <div class="customer-name">${firstName} ${lastName}</div>
        <div class="customer-score">${score} pts</div>
      `;
      list.appendChild(item);
    }
  });

  // Menu Section (full)
  renderMenu(MENU_DATA.dishes);

  // Cart badge
  updateCartUI();
  
  // Setup food tags filter
  setupFoodTagsFilter();
  
  // Update favorites list
  updateFavoritesList();
}

/* ======== Setup food tags filter ======== */
function setupFoodTagsFilter() {
  document.querySelectorAll('.filter-tag').forEach(tag => {
    tag.addEventListener('click', () => {
      tag.classList.toggle('selected');
      const tagValue = tag.dataset.tag;
      
      if (tag.classList.contains('selected')) {
        state.selectedTags.push(tagValue);
      } else {
        state.selectedTags = state.selectedTags.filter(t => t !== tagValue);
      }
      
      applyFilters();
    });
  });
}

/* ======== Apply all filters ======== */
function applyFilters() {
  let filteredDishes = MENU_DATA.dishes;
  
  // Apply price filter
  const minPrice = Number(document.getElementById('minPrice').value) || 0;
  const maxPrice = Number(document.getElementById('maxPrice').value) || Infinity;
  filteredDishes = filteredDishes.filter(d => d.price >= minPrice && d.price <= maxPrice);
  
  // Apply tag filter
  if (state.selectedTags.length > 0) {
    filteredDishes = filteredDishes.filter(d => {
      return state.selectedTags.some(tag => d.tags.includes(tag));
    });
  }
  
  renderMenu(filteredDishes);
}

/* ======== Render menú ======== */
function renderMenu(dishes){
  const menuSection = document.getElementById('menuSection');
  menuSection.innerHTML = '';

  // Organizar platos por categoría
  const dishesByCategory = {};
  MENU_DATA.categories.forEach(cat => {
    if (cat.subcategories) {
      cat.subcategories.forEach(sub => {
        dishesByCategory[sub.id] = dishes.filter(d => d.category === sub.id);
      });
    } else {
      dishesByCategory[cat.id] = dishes.filter(d => d.category === cat.id);
    }
  });

  // Crear secciones para cada categoría
  Object.keys(dishesByCategory).forEach(catId => {
    const catDishes = dishesByCategory[catId];
    if (catDishes.length === 0) return;
    
    // Encontrar el nombre de la categoría
    let categoryName = '';
    MENU_DATA.categories.forEach(cat => {
      if (cat.subcategories) {
        const sub = cat.subcategories.find(s => s.id === catId);
        if (sub) categoryName = sub.name;
      } else if (cat.id === catId) {
        categoryName = cat.name;
      }
    });
    
    const catSection = document.createElement('section');
    catSection.className = 'category-section';
    catSection.innerHTML = `
      <div class="category-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div>
          <div class="category-title" style="color:var(--accent)">${categoryName}</div>
          <div class="category-count" style="background:var(--surface-light);color:var(--text-muted);padding:4px 8px;border-radius:12px;font-size:12px">${catDishes.length} items</div>
        </div>
      </div>
      <div class="category-carousel" id="carousel_${catId}"></div>
    `;
    menuSection.appendChild(catSection);

    const carousel = catSection.querySelector(`#carousel_${catId}`);
    
    // Mostrar solo 2 platos por categoría
    const displayedDishes = catDishes.slice(0, 2);
    
    displayedDishes.forEach(d => {
      const card = document.createElement('div');
      card.className='dish-card category-carousel-item';
      card.innerHTML = `
        <div class="dish-image"><img src="${d.img}" alt="${d.name}"></div>
        <div class="dish-content">
          <div>
            <div class="dish-header"><div class="dish-name">${d.name}</div><div class="dish-price">$${d.price}</div></div>
            <div class="dish-description" style="color:var(--text-muted);font-size:13px">${d.description}</div>
            ${d.tags.length > 0 ? `<div class="dish-tags" style="display:flex;gap:4px;margin-top:4px;flex-wrap:wrap">${d.tags.map(tag => `<span style="background:var(--surface);color:var(--accent);padding:2px 6px;border-radius:10px;font-size:10px;border:1px solid var(--accent)">${tag}</span>`).join('')}</div>` : ''}
          </div>
          <div class="dish-actions">
            <div style="display:flex;gap:8px;align-items:center">
              <button class="qty-btn" data-action="fav" title="Favorito"><i class="fas fa-heart"></i></button>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="add-to-cart-btn" data-id="${d.id}"><i class="fas fa-cart-plus"></i> Agregar</button>
            </div>
          </div>
        </div>
      `;
      // click image or card to open detail
      card.addEventListener('click', (e) => {
        // Solo seleccionar si no se hizo clic en un botón
        if (!e.target.closest('button')) {
          // Remover selección de todas las tarjetas
          document.querySelectorAll('.dish-card').forEach(c => c.classList.remove('selected'));
          // Seleccionar esta tarjeta
          card.classList.add('selected');
          openDishDetail(d.id);
        }
      });
      // favorite
      card.querySelector('[data-action="fav"]').addEventListener('click', (e)=>{
        e.stopPropagation();
        toggleFavorite(d.id, e.currentTarget);
      });
      // add to cart
      card.querySelector('.add-to-cart-btn').addEventListener('click', (e)=>{
        e.stopPropagation();
        addToCart(d.id,1);
      });
      carousel.appendChild(card);
    });
  });
}

/* ======== Favoritos ======== */
function toggleFavorite(dishId, btnEl){
  if(state.favorites[dishId]){ 
    delete state.favorites[dishId]; 
    toast('Eliminado de favoritos'); 
    btnEl.classList.remove('active'); 
  } else { 
    state.favorites[dishId]=true; 
    toast('Añadido a favoritos'); 
    btnEl.classList.add('active'); 
  }
  saveState();
  updateFavoritesList();
}

/* ======== Actualizar lista de favoritos ======== */
function updateFavoritesList() {
  const favoritesList = document.getElementById('favoritesList');
  favoritesList.innerHTML = '';
  
  const favoriteDishes = Object.keys(state.favorites)
    .map(id => MENU_DATA.dishes.find(d => d.id === id))
    .filter(d => d); // Filtrar undefined
  
  if (favoriteDishes.length === 0) {
    favoritesList.innerHTML = '<div style="color:var(--text-muted);padding:8px">No hay platos favoritos</div>';
    return;
  }
  
  favoriteDishes.forEach(dish => {
    const item = document.createElement('div');
    item.className = 'favorite-item';
    item.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px">
        <img src="${dish.img}" style="width:40px;height:40px;object-fit:cover;border-radius:6px">
        <div>
          <div style="font-weight:700">${dish.name}</div>
          <div style="color:var(--text-muted);font-size:12px">$${dish.price}</div>
        </div>
      </div>
      <div class="favorite-vote">
        <button class="vote-btn" data-action="downvote" data-id="${dish.id}"><i class="fas fa-chevron-down"></i></button>
        <span class="vote-count">${state.dishVotes[dish.id] || 0}</span>
        <button class="vote-btn" data-action="upvote" data-id="${dish.id}"><i class="fas fa-chevron-up"></i></button>
      </div>
    `;
    favoritesList.appendChild(item);
  });
  
  // Agregar eventos de votación
  favoritesList.querySelectorAll('.vote-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const dishId = btn.dataset.id;
      const action = btn.dataset.action;
      
      if (!state.dishVotes[dishId]) {
        state.dishVotes[dishId] = 0;
      }
      
      if (action === 'upvote') {
        state.dishVotes[dishId]++;
        toast('Voto positivo agregado');
      } else if (action === 'downvote') {
        state.dishVotes[dishId]--;
        toast('Voto negativo agregado');
      }
      
      saveState();
      updateFavoritesList();
    });
  });
}

/* ======== Dish detail modal ======== */
function openDishDetail(dishId){
  const d = MENU_DATA.dishes.find(x=>x.id===dishId);
  if(!d) return;
  document.getElementById('detailImage').src = d.img;
  document.getElementById('detailName').textContent = d.name;
  document.getElementById('detailPrice').textContent = `$${d.price}`;
  document.getElementById('detailDescription').textContent = d.description;
  document.getElementById('detailQuantity').textContent = 1;
  
  // Mostrar etiquetas
  const tagsContainer = document.getElementById('detailTags');
  tagsContainer.innerHTML = '';
  if (d.tags && d.tags.length > 0) {
    d.tags.forEach(tag => {
      const tagEl = document.createElement('span');
      tagEl.style.background = 'var(--surface)';
      tagEl.style.color = 'var(--accent)';
      tagEl.style.padding = '2px 6px';
      tagEl.style.borderRadius = '10px';
      tagEl.style.fontSize = '10px';
      tagEl.style.border = '1px solid var(--accent)';
      tagEl.textContent = tag;
      tagsContainer.appendChild(tagEl);
    });
  }
  
  document.getElementById('dishDetailModal').classList.add('open');

  // handlers
  document.getElementById('detailIncrease').onclick = ()=> {
    const q = Number(document.getElementById('detailQuantity').textContent) + 1;
    document.getElementById('detailQuantity').textContent = q;
  };
  document.getElementById('detailDecrease').onclick = ()=> {
    const q = Math.max(1, Number(document.getElementById('detailQuantity').textContent) - 1);
    document.getElementById('detailQuantity').textContent = q;
  };
  document.getElementById('detailAddToCart').onclick = ()=> {
    const q = Number(document.getElementById('detailQuantity').textContent);
    addToCart(dishId, q);
    closeDishDetail();
  };
  document.getElementById('detailReset').onclick = ()=> {
    document.getElementById('detailQuantity').textContent = 1;
  };
  document.getElementById('detailFavorite').onclick = ()=> {
    toggleFavorite(dishId, document.getElementById('detailFavorite'));
    if (state.favorites[dishId]) {
      document.getElementById('detailFavorite').innerHTML = '<i class="fas fa-heart"></i> Favorito';
    } else {
      document.getElementById('detailFavorite').innerHTML = '<i class="far fa-heart"></i> Favorito';
    }
  };
}
function closeDishDetail(){ 
  document.getElementById('dishDetailModal').classList.remove('open'); 
  // Remover selección de todas las tarjetas al cerrar el modal
  document.querySelectorAll('.dish-card').forEach(c => c.classList.remove('selected'));
}

/* ======== Cart logic ======== */
function addToCart(dishId, qty=1){
  if(!state.cart[dishId]) state.cart[dishId]=0;
  state.cart[dishId] += qty;
  saveState();
  updateCartUI();
  toast('Agregado al pedido');
}
function removeFromCart(dishId){
  delete state.cart[dishId];
  saveState();
  updateCartUI();
}
function changeQty(dishId, qty){
  if(qty<=0) removeFromCart(dishId);
  else state.cart[dishId] = qty;
  saveState();
  updateCartUI();
}
function updateCartUI(){
  const cartItemsEl = document.getElementById('cartItems');
  cartItemsEl.innerHTML = '';
  let total = 0;
  const keys = Object.keys(state.cart);
  if(keys.length===0){
    cartItemsEl.innerHTML = '<div style="color:var(--text-muted);padding:8px">Tu carrito está vacío</div>';
  } else {
    keys.forEach(id=>{
      const quantity = state.cart[id];
      const dish = MENU_DATA.dishes.find(d=>d.id===id);
      if(!dish) return;
      const item = document.createElement('div');
      item.className='cart-item';
      item.style.display='flex'; item.style.alignItems='center'; item.style.justifyContent='space-between';
      item.innerHTML = `
        <div style="display:flex;gap:8px;align-items:center">
          <img src="${dish.img}" style="width:50px;height:50px;object-fit:cover;border-radius:6px">
          <div style="min-width:140px">
            <div style="font-weight:700">${dish.name}</div>
            <div style="color:var(--text-muted);font-size:13px">$${dish.price} x ${quantity}</div>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
          <div style="display:flex;gap:6px;align-items:center">
            <button class="qty-btn" data-action="dec" data-id="${id}">-</button>
            <div style="min-width:22px;text-align:center">${quantity}</div>
            <button class="qty-btn" data-action="inc" data-id="${id}">+</button>
          </div>
          <button class="nav-btn" data-action="remove" data-id="${id}" style="background:transparent">Eliminar</button>
        </div>
      `;
      cartItemsEl.appendChild(item);
      total += dish.price * quantity;
    });
  }
  document.getElementById('cartTotal').textContent = `$${total}`;
  document.getElementById('cartCount').textContent = Object.values(state.cart).reduce((a,b)=>a+b,0);
  // attach events
  cartItemsEl.querySelectorAll('[data-action="inc"]').forEach(btn=>{
    btn.addEventListener('click', ()=> {
      const id = btn.dataset.id;
      changeQty(id, state.cart[id]+1);
    });
  });
  cartItemsEl.querySelectorAll('[data-action="dec"]').forEach(btn=>{
    btn.addEventListener('click', ()=> {
      const id = btn.dataset.id;
      changeQty(id, Math.max(0, state.cart[id]-1));
    });
  });
  cartItemsEl.querySelectorAll('[data-action="remove"]').forEach(btn=>{
    btn.addEventListener('click', ()=> {
      removeFromCart(btn.dataset.id);
    });
  });

  // enable/disable checkout
  document.getElementById('checkoutBtn').disabled = Object.keys(state.cart).length===0;
  
  // Update split calculator total
  updateSplitCalculator(total);
}

/* ======== Split calculator ======== */
function updateSplitCalculator(total) {
  document.getElementById('splitTotal').textContent = `$${total}`;
  
  // Set default split to 1
  document.querySelectorAll('.split-option').forEach(opt => {
    opt.classList.remove('selected');
    if (opt.dataset.split === '1') {
      opt.classList.add('selected');
    }
  });
  
  // Update per person amount
  document.getElementById('splitPerPerson').textContent = `$${total}`;
}

function setupSplitCalculator() {
  document.querySelectorAll('.split-option').forEach(opt => {
    opt.addEventListener('click', () => {
      document.querySelectorAll('.split-option').forEach(o => o.classList.remove('selected'));
      opt.classList.add('selected');
      
      const total = parseFloat(document.getElementById('splitTotal').textContent.replace('$', ''));
      const split = parseInt(opt.dataset.split);
      const perPerson = total / split;
      
      document.getElementById('splitPerPerson').textContent = `$${perPerson.toFixed(2)}`;
    });
  });
}

/* ======== Navigation / sidebar / cart toggles ======== */
function openSidebar(){ document.getElementById('sidebarNav').classList.add('open'); document.getElementById('sidebarOverlay').classList.add('open'); }
function closeSidebar(){ document.getElementById('sidebarNav').classList.remove('open'); document.getElementById('sidebarOverlay').classList.remove('open'); }

function openCart(){ document.getElementById('cartSidebar').classList.add('open'); document.getElementById('cartOverlay').classList.add('open'); }
function closeCart(){ document.getElementById('cartSidebar').classList.remove('open'); document.getElementById('cartOverlay').classList.remove('open'); }

document.getElementById('hamburgerMenu').addEventListener('click', openSidebar);
document.getElementById('closeSidebar').addEventListener('click', closeSidebar);
document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);
document.getElementById('cartIcon').addEventListener('click', openCart);
document.getElementById('closeCart').addEventListener('click', closeCart);
document.getElementById('cartOverlay').addEventListener('click', closeCart);

/* ======== Page switches ======== */
document.getElementById('menuBtn').addEventListener('click', ()=>{ showView('menuView'); });
document.getElementById('homeBtn').addEventListener('click', ()=>{ showView('homeView'); });
document.getElementById('backBtn').addEventListener('click', ()=>{ showView('homeView'); });

function showView(id){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

/* ======== Search & filter ======== */
document.getElementById('sidebarSearch').addEventListener('input', (e)=>{
  const q = e.target.value.trim().toLowerCase();
  const filtered = MENU_DATA.dishes.filter(d => d.name.toLowerCase().includes(q) || d.description.toLowerCase().includes(q));
  renderMenu(filtered);
});

document.getElementById('applyPriceFilter').addEventListener('click', ()=>{
  applyFilters();
});
document.getElementById('clearPriceFilter').addEventListener('click', ()=>{
  document.getElementById('minPrice').value=''; 
  document.getElementById('maxPrice').value=''; 
  state.selectedTags = [];
  document.querySelectorAll('.filter-tag').forEach(tag => tag.classList.remove('selected'));
  renderMenu(MENU_DATA.dishes);
});

/* ======== Category view helper ======== */
function showCategory(catId){
  const filtered = MENU_DATA.dishes.filter(d=>d.category===catId);
  renderMenu(filtered);
  showView('menuView');
}

/* ======== Call waiter ======== */
document.getElementById('callWaiterBtn').addEventListener('click', ()=>{
  toast('Se ha notificado al mozo. Gracias!');
});

/* ======== Dish detail close ======== */
document.getElementById('closeDetail').addEventListener('click', closeDishDetail);
document.getElementById('dishDetailModal').addEventListener('click', (e)=>{
  if(e.target.id==='dishDetailModal') closeDishDetail();
});

/* ======== Payment flow ======== */
document.getElementById('checkoutBtn').addEventListener('click', ()=>{
  // open payment choice modal
  document.getElementById('paymentChoiceModal').classList.add('open');
});
document.getElementById('closePaymentChoice').addEventListener('click', ()=> document.getElementById('paymentChoiceModal').classList.remove('open'));
document.getElementById('cancelPaymentChoice').addEventListener('click', ()=> document.getElementById('paymentChoiceModal').classList.remove('open'));

document.querySelectorAll('.payment-choice-option').forEach(opt=>{
  opt.addEventListener('click', ()=> {
    document.querySelectorAll('.payment-choice-option').forEach(x=>x.classList.remove('active'));
    opt.classList.add('active');
    state.paymentChoice = opt.dataset.choice;
  });
});

document.getElementById('confirmPaymentChoice').addEventListener('click', ()=>{
  if(!state.paymentChoice){ toast('Seleccione una opción de pago', 'error'); return; }
  document.getElementById('paymentChoiceModal').classList.remove('open');
  if(state.paymentChoice === 'now') {
    openPaymentModal();
  } else {
    closeCart();
    toast('Pedido creado con pago al finalizar (Pago pendiente)');
    document.getElementById('pendingPayment').classList.remove('hidden');
    document.getElementById('checkoutBtn').classList.add('hidden');
  }
});

/* ======== Payment modal handlers ======== */
function openPaymentModal(){
  document.getElementById('paymentModal').classList.add('open');
  renderReceipt();
}
document.getElementById('closePayment').addEventListener('click', ()=> document.getElementById('paymentModal').classList.remove('open'));
document.getElementById('cancelPayment').addEventListener('click', ()=> document.getElementById('paymentModal').classList.remove('open'));

document.querySelectorAll('.payment-option').forEach(opt=>{
  opt.addEventListener('click', ()=> {
    document.querySelectorAll('.payment-option').forEach(x=>x.classList.remove('selected'));
    opt.classList.add('selected');
    state.paymentMethod = opt.dataset.method;
  });
});
document.querySelectorAll('.tip-option').forEach(t=>{
  t.addEventListener('click', ()=>{
    document.querySelectorAll('.tip-option').forEach(x=>x.classList.remove('selected'));
    t.classList.add('selected');
    state.tipPercent = Number(t.dataset.tip);
    renderReceipt();
  });
});

/* Render receipt inside modal */
function renderReceipt(){
  const receiptEl = document.getElementById('paymentReceipt');
  let total = 0;
  const lines = [];
  for(const id in state.cart){
    const dish = MENU_DATA.dishes.find(d=>d.id===id);
    const qty = state.cart[id];
    if(!dish) continue;
    const subtotal = dish.price * qty;
    lines.push({name:dish.name, qty, price: dish.price, subtotal});
    total += subtotal;
  }
  const tip = Math.round(total * (state.tipPercent/100));
  const totalWithTip = total + tip;
  let html = `<div><strong>Items:</strong></div>`;
  lines.forEach(l => html += `<div style="display:flex;justify-content:space-between"><div>${l.qty}x ${l.name}</div><div>$${l.subtotal}</div></div>`);
  html += `<hr><div style="display:flex;justify-content:space-between"><div>Subtotal</div><div>$${total}</div></div>`;
  html += `<div style="display:flex;justify-content:space-between"><div>Propina (${state.tipPercent}%)</div><div>$${tip}</div></div>`;
  html += `<div style="display:flex;justify-content:space-between;font-weight:800;margin-top:6px"><div>Total</div><div>$${totalWithTip}</div></div>`;
  receiptEl.innerHTML = html;

  // store last receipt data (used for PDF if payment successful)
  state.lastReceiptLines = lines.slice();
  state.lastReceiptTotals = { subtotal: total, tip, total: totalWithTip };
}

/* ======== Confirm payment (si es Mercado Pago, llama al backend para crear preferencia) ======== */
document.getElementById('confirmPayment').addEventListener('click', async ()=>{
  if(!state.paymentMethod){ toast('Seleccione un método de pago', 'error'); return; }
  // Si el método elegido es Mercado Pago, creamos la preferencia real en el backend
  if(state.paymentMethod === 'mercado-pago'){
    // Preparamos items para enviar al servidor
    const items = Object.entries(state.cart).map(([id, qty])=>{
      const d = MENU_DATA.dishes.find(x=>x.id===id);
      return { title: d.name, unit_price: d.price, quantity: qty };
    });
    if(items.length === 0){ toast('Carrito vacío', 'error'); return; }

    try {
      document.getElementById('confirmPayment').disabled = true;
      document.getElementById('confirmPayment').textContent = 'Creando pago...';
      const res = await fetch(`${BACKEND_URL}/create_preference`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items })
      });
      const data = await res.json();
      document.getElementById('confirmPayment').disabled = false;
      document.getElementById('confirmPayment').textContent = 'Confirmar Pago';
      if(data && data.init_point){
        // Abrir checkout de Mercado Pago en nueva pestaña
        window.open(data.init_point, '_blank');

        // Opcional: generar recibo local y limpiar carrito
        generatePDFReceipt(state.lastReceiptLines, state.lastReceiptTotals);
        state.cart = {};
        saveState();
        updateCartUI();
        closeCart();
        document.getElementById('paymentModal').classList.remove('open');
        toast('Redirigiendo a Mercado Pago — verifica la ventana nueva.');
      } else {
        console.error(data);
        toast('No se obtuvo init_point desde el servidor', 'error');
      }
    } catch (err) {
      console.error(err);
      document.getElementById('confirmPayment').disabled = false;
      document.getElementById('confirmPayment').textContent = 'Confirmar Pago';
      toast('Error conectando con el servidor de pagos', 'error');
    }
    return;
  }

  // Flujos simulados para otros métodos
  document.getElementById('confirmPayment').disabled = true;
  document.getElementById('confirmPayment').textContent = 'Procesando...';
  setTimeout(()=>{
    // generar pdf con la data almacenada
    generatePDFReceipt(state.lastReceiptLines, state.lastReceiptTotals);
    state.cart = {};
    saveState();
    updateCartUI();
    closeCart();
    document.getElementById('paymentModal').classList.remove('open');
    document.getElementById('confirmPayment').disabled = false;
    document.getElementById('confirmPayment').textContent = 'Confirmar Pago';
    toast('Pago simulado realizado — Comprobante generado');
  }, 900);
});

/* Generate PDF with jsPDF */
function generatePDFReceipt(lines, totals){
  try{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(16);
    doc.text(MENU_DATA.restaurant, 14, 20);
    doc.setFontSize(11);
    doc.text('Comprobante de pago (simulado)', 14, 30);
    let y = 42;
    lines.forEach(l=>{
      doc.text(`${l.qty} x ${l.name} — $${l.subtotal}`, 14, y);
      y += 7;
      if(y > 270){ doc.addPage(); y = 20; }
    });
    y += 6;
    doc.text(`Subtotal: $${totals.subtotal}`, 14, y); y += 7;
    doc.text(`Propina: $${totals.tip}`, 14, y); y += 7;
    doc.text(`Total: $${totals.total}`, 14, y); y += 10;
    doc.text(`Fecha: ${new Date().toLocaleString()}`, 14, y);
    doc.save('comprobante.pdf');
  }catch(err){
    console.error('Error generando PDF:', err);
  }
}

/* ======== Registration / Login (simulado) ======== */
document.getElementById('sidebarRegisterBtn').addEventListener('click', ()=> openRegistration());
document.getElementById('sidebarLoginBtn').addEventListener('click', ()=> openLogin());
document.getElementById('sendVerificationCode').addEventListener('click', ()=>{
  const phone = document.getElementById('phoneNumber').value.trim();
  const pass = document.getElementById('password').value.trim();
  if(!phone || !pass){ toast('Complete los datos', 'error'); return; }
  document.getElementById('verificationSection').classList.remove('hidden');
  toast('Código enviado (simulado): 123456');
});
document.getElementById('verifyCode').addEventListener('click', ()=>{
  const code = document.getElementById('verificationCode').value.trim();
  if(code==='123456'){
    const user = { phone: document.getElementById('phoneNumber').value.trim(), alias: document.getElementById('alias').value.trim() || null };
    state.user = user; saveState();
    document.getElementById('registrationModal').classList.remove('open');
    toast('Registro completado. ¡Bienvenido!');
  } else { toast('Código incorrecto', 'error'); }
});
document.getElementById('cancelRegistration').addEventListener('click', ()=> document.getElementById('registrationModal').classList.remove('open'));
document.getElementById('closeRegistration').addEventListener('click', ()=> document.getElementById('registrationModal').classList.remove('open'));

function openRegistration(){ document.getElementById('registrationModal').classList.add('open'); }

document.getElementById('loginBtn').addEventListener('click', ()=>{
  const phone = document.getElementById('loginPhone').value.trim();
  const pass = document.getElementById('loginPassword').value.trim();
  if(!phone || !pass){ toast('Complete los datos', 'error'); return; }
  state.user = { phone, alias: null }; saveState();
  document.getElementById('loginModal').classList.remove('open');
  toast('Sesión iniciada (simulado)');
});
document.getElementById('cancelLogin').addEventListener('click', ()=> document.getElementById('loginModal').classList.remove('open'));
document.getElementById('closeLogin').addEventListener('click', ()=> document.getElementById('loginModal').classList.remove('open'));

function openLogin(){ document.getElementById('loginModal').classList.add('open'); }

/* ======== Other small features ======== */
document.getElementById('requestBillBtn').addEventListener('click', ()=> {
  toast('La cuenta será traída. Gracias!');
});

/* ======== Utilities: click outside modals to close & ESC ======== */
window.addEventListener('keydown', (e)=> {
  if(e.key==='Escape'){
    document.querySelectorAll('.modal.open, .dish-detail-modal.open, .payment-choice-modal.open, .registration-modal.open, .login-modal.open').forEach(m=>m.classList.remove('open'));
  }
});

/* ======== Init ======== */
initUI();
renderReceipt();
updateCartUI();
setupSplitCalculator();
</script>
</body>
</html>